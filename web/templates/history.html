{% extends "vehicle_base.html" %}

{% block title %}{{ vehicle.car.name }} - History{% endblock %}

{% block tab_content %}
<!-- Summary + Add entry + Hide verbs in one row -->
<form id="filter-form" method="get" action="{{ url_for('vehicle_history', vehicle_id=vehicle_id) }}" class="mb-4">
    <div class="flex flex-wrap items-center gap-2 p-3 bg-white rounded-lg border border-gray-200 text-sm text-gray-600">
        <!-- Summary -->
        <span class="font-medium">Total entries:</span>
        <span class="font-medium text-lg">{{ history_with_index | length }}</span>
        <span class="font-medium ml-2">Total cost:</span>
        <span class="font-medium text-lg">${{ "%.2f" | format(total_cost) }}</span>

        <!-- Add entry + Hide verbs -->
        <div class="ml-auto flex items-center gap-2">
            <button type="button"
                    hx-get="{{ url_for('log_service_form', vehicle_id=vehicle_id) }}"
                    hx-target="#modal-content"
                    hx-swap="innerHTML"
                    hx-trigger="click"
                    onclick="document.getElementById('modal').classList.remove('hidden')"
                    class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg border border-transparent text-sm font-medium touch-target">
                Add entry
            </button>
        {% include "partials/verb_filter_dropdown.html" %}
        </div>
    </div>
</form>

<!-- History List - accordion style with year separators -->
<div class="space-y-1.5">
    {% set ns = namespace(current_year='') %}
    {% for index, entry in history_with_index %}
    {% set entry_year = entry.date[:4] %}
    {% if entry_year != ns.current_year %}
    {% set ns.current_year = entry_year %}
    <div class="flex items-center gap-2 py-2 {% if not loop.first %}mt-3{% endif %}">
        <div class="h-px bg-gray-300 flex-1"></div>
        <span class="text-sm font-semibold text-gray-500 px-2">{{ entry_year }}</span>
        <div class="h-px bg-gray-300 flex-1"></div>
    </div>
    {% endif %}
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <!-- Collapsed header - clickable -->
        <div class="px-3 py-2 cursor-pointer flex items-center justify-between gap-2"
             onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('rotate-180')">
            <div class="flex-1 min-w-0 overflow-hidden">
                {% set rk_parts = entry.rule_key.split("/") %}
                <span class="block font-medium text-gray-900 text-sm truncate min-w-0">
                    {% if rk_parts | length > 1 %}{{ rk_parts[1] | capitalize }} {{ rk_parts[0] }}{% if rk_parts | length > 2 %} <span class="text-gray-400">[{{ rk_parts[2] }}]</span>{% endif %}{% else %}{{ entry.rule_key }}{% endif %}
                </span>
            </div>
            <div class="flex items-center gap-2 shrink-0">
                <span class="text-xs text-gray-500 whitespace-nowrap w-[7rem] text-right tabular-nums">{{ entry.date }}</span>
                <span class="text-xs text-gray-600 whitespace-nowrap w-[5.5rem] text-right tabular-nums">
                    {% if entry.mileage %}{{ entry.mileage | format_miles }} mi{% else %}—{% endif %}
                </span>
                <span class="text-xs font-medium text-green-600 whitespace-nowrap w-[4.5rem] text-right tabular-nums">
                    {% if entry.cost %}${{ "%.2f" | format(entry.cost) }}{% else %}—{% endif %}
                </span>
                <svg class="chevron w-4 h-4 text-gray-400 transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <!-- Expanded details - hidden by default -->
        <div class="hidden border-t border-gray-100 px-3 py-2 bg-gray-50">
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                    <p class="text-gray-500 text-xs">Date</p>
                    <p class="font-medium">{{ entry.date }}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">Mileage</p>
                    <p class="font-medium">{% if entry.mileage %}{{ entry.mileage | format_miles }} mi{% else %}—{% endif %}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">Cost</p>
                    <p class="font-medium">{% if entry.cost %}${{ "%.2f" | format(entry.cost) }}{% else %}—{% endif %}</p>
                </div>
                <div>
                    <p class="text-gray-500 text-xs">Performed by</p>
                    <p class="font-medium">{% if entry.performed_by %}{{ entry.performed_by }}{% else %}—{% endif %}</p>
                </div>
                <div class="col-span-2">
                    <p class="text-gray-500 text-xs">Notes</p>
                    <p class="font-medium">{% if entry.notes %}{{ entry.notes }}{% else %}—{% endif %}</p>
                </div>
            </div>
            {% with edit_url=url_for('edit_history_form', vehicle_id=vehicle_id, index=index), delete_url=url_for('delete_history', vehicle_id=vehicle_id, index=index), edit_label="Edit entry", delete_label="Delete entry" %}
            {% include "partials/modal_action_buttons.html" %}
            {% endwith %}
        </div>
    </div>
    {% else %}
    {% with message="No service history yet.", submessage="Tap the + button to log a service." %}
    {% include "partials/empty_state.html" %}
    {% endwith %}
    {% endfor %}
</div>

{% endblock %}
